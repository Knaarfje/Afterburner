"use strict";var reg;"serviceWorker"in navigator&&(console.log("Service Worker is supported"),navigator.serviceWorker.register("/serviceworker.js").then(function(){return navigator.serviceWorker.ready}).then(function(serviceWorkerRegistration){console.log("Service Worker is ready :^)",reg),reg=serviceWorkerRegistration})["catch"](function(error){console.log("Service Worker error :^(",error)}),navigator.serviceWorker.getRegistrations().then(function(a){for(var i in a)a[i].active.scriptURL.indexOf("/scripts/ser")>=0&&a[i].unregister()}));var app=angular.module("afterburnerApp",["firebase","ngTouch","ngRoute","angular.filter","ng-sortable","ui.router","monospaced.elastic"]),templatePath="./Assets/dist/Templates";app.config(function($locationProvider,$firebaseRefProvider,$stateProvider,$urlRouterProvider){var config={apiKey:"AIzaSyCIzyCEYRjS4ufhedxwB4vCC9la52GsrXM",authDomain:"project-7784811851232431954.firebaseapp.com",databaseURL:"https://project-7784811851232431954.firebaseio.com",storageBucket:"project-7784811851232431954.appspot.com",messagingSenderId:"767810429309"};$locationProvider.html5Mode(!0),$firebaseRefProvider.registerUrl(config.databaseURL),firebase.initializeApp(config),$urlRouterProvider.otherwise("/"),$stateProvider.state({name:"signin",url:"/signin",template:"<signin></signin>"}).state("default",{url:"/",resolve:{chart:function(SprintService){return SprintService.getOverviewChart()}},template:'\n                <app>\n                    <sprints title="\'Overview\'" \n                             back-title="\'Velocity\'" \n                             chart="$resolve.chart">\n                    </sprints> \n                </app>'}).state("current-sprint",{url:"/current-sprint",resolve:{chart:function(SprintService){return SprintService.getCurrentChart()}},template:'\n                <app>\n                    <sprints title="$resolve.chart.name" \n                             back-title="\'Burndown\'" \n                             chart="$resolve.chart"\n                             backlog="true">\n                    </sprints>\n                </app>'}).state("sprint",{url:"/sprint/:sprint",resolve:{chart:function(SprintService,$stateParams){var sprint=$stateParams.sprint;return SprintService.getSprintChart(sprint)}},template:'\n                <app>\n                    <sprints title="$resolve.chart.name" \n                             back-title="\'Burndown\'" \n                             chart="$resolve.chart"\n                             backlog="true">\n                    </sprints>\n                </app>'}).state("bigscreen",{url:"/bigscreen",resolve:{chart:function(SprintService){return SprintService.getOverviewChart()}},template:'\n                <bigscreen>\n                    <sprints title="\'Overview\'" \n                             back-title="\'Velocity\'" \n                             chart="$resolve.chart">\n                    </sprints> \n                </bigscreen>'}).state("bigscreen.current-sprint",{url:"/bigscreen/current-sprint",resolve:{chart:function(SprintService){return SprintService.getCurrentChart()}},template:'\n                <bigscreen>\n                    <sprints title="$resolve.chart.name" \n                             back-title="\'Burndown\'" \n                             chart="$resolve.chart"\n                             backlog="false">\n                    </sprints>\n                </bigscreen>'}).state("bigscreen.sprint",{url:"/bigscreen/sprint/:sprint",resolve:{chart:function(SprintService,$route){var sprint=$stateParams.sprint;return SprintService.getSprintChart(sprint)}},template:'\n                <bigscreen>\n                    <sprints title="$resolve.chart.name" \n                             back-title="\'Burndown\'" \n                             chart="$resolve.chart"\n                             backlog="false">\n                    </sprints>\n                </bigscreen>'}).state("backlog",{url:"/backlog",resolve:{firebaseUser:function($firebaseAuthService){return $firebaseAuthService.$waitForSignIn()},backlog:function(BacklogService){return BacklogService.getBacklog()}},template:'\n                <app>\n                    <backlog title="\'Backlog\'"\n                             back-title="\'Overview\'"\n                             bi-items="$resolve.backlog">\n                    </backlog> \n                </app>'}).state("backlog.item",{url:"/:item",resolve:{firebaseUser:function($firebaseAuthService){return $firebaseAuthService.$waitForSignIn()},key:function($stateParams){return $stateParams.item}},reloadOnSearch:!1,template:' \n            <div class="col-lg-6 backlog-form" ng-class="{\'active\': $ctrl.selectedItem}">               \n\t\t\t<backlog-form \n\t\t\t\titem="$ctrl.selectedItem"\n                items="$ctrl.biItems"\n                item-key="$resolve.key"\n\t\t\t\tattachments="$ctrl.selectedItemAttachments"\n\t\t\t\tsprints="$ctrl.sprints" \n\t\t\t\ton-add="$ctrl.addItem()"                 \n\t\t\t\ton-select="$ctrl.getItem($resolve.key)" \n\t\t\t\ton-delete="$ctrl.deleteItem($ctrl.selectedItem)" \n\t\t\t\ton-save="$ctrl.saveItem($ctrl.selectedItem)">\n\t\t\t</backlog-form>\n            </div>'}).state("retro",{url:"/retro",resolve:{firebaseUser:function($firebaseAuthService){return $firebaseAuthService.$waitForSignIn()}},template:"\n                <app>\n                    <retro title=\"'Retro'\"\n                             back-title=\"'Afspraken'\">\n                    </retro>\n                </app>"})}),app.component("app",{transclude:!0,controller:function($location,$firebaseAuth,SprintService){var ctrl=this,auth=$firebaseAuth();ctrl.auth=auth,auth.$getAuth()||$location.path("/signin"),ctrl.navOpen=!1,ctrl.signOut=function(){ctrl.auth.$signOut(),$location.path("/signin")}},templateUrl:templatePath+"/app.html"}),app.component("backlog",{bindings:{title:"<",backTitle:"<",itemKey:"<",biItems:"<"},controller:function(BacklogService,SprintService,$firebaseAuth,$firebaseArray,FileService,$scope,NotificationService,$location,SettingService){var ctrl=this;$firebaseAuth();ctrl.settings=SettingService,ctrl.formOpen=!1,ctrl.state={New:"0",Approved:"1",Done:"3",Removed:"4"},ctrl.filter={},ctrl.open=!0,ctrl.$onInit=function(){ctrl.itemKey&&ctrl.selectItem(ctrl.biItems.$getRecord(ctrl.itemKey)),ctrl.viewMode=ctrl.settings.get("ViewMode",0)},SprintService.getSprints(function(sprints){ctrl.sprints=sprints},!0),ctrl.customOrder=function(key){return ctrl.sprints?key.sprint?-ctrl.sprints.$getRecord(key.sprint).order:9999:0},ctrl.setViewMode=function(mode){ctrl.viewMode=mode,ctrl.settings.set("ViewMode",mode)},ctrl.reOrder=function(group,a){group&&(ctrl.reordering=!0,group.forEach(function(item,index){var i=ctrl.biItems.$getRecord(item.$id);i.$priority=index,BacklogService.save(i).then()}))},ctrl.sumEffort=function(items){var sum=0;for(var i in items)sum+=items[i].effort;return sum},ctrl.orderBySprint=function(key){return key?ctrl.sprints.$getRecord(key).order:99999},ctrl.selectItem=function(item){ctrl.formOpen=!0,ctrl.selectedItem=item,FileService.getAttachments(item).then(function(data){ctrl.selectedItemAttachments=data}),$location.path("/backlog/"+item.$id)},ctrl.addItem=function(){var newItem={name:"Nieuw...",effort:0,description:"",order:-1,state:0,sprint:""};BacklogService.add(newItem).then(function(data){ctrl.selectItem(ctrl.biItems.$getRecord(data.key)),ctrl.formOpen=!0})},ctrl.deleteItem=function(item){ctrl.biItems.indexOf(item);BacklogService.remove(item).then(function(){ctrl.selectedItem=null,ctrl.formOpen=!1})},ctrl.saveItem=function(item){item.state==ctrl.state.Done?(item.resolvedOn||NotificationService.notify("Smells like fire...",'Work on "'+item.name+'" has been completed!'),item.resolvedOn=item.resolvedOn||Date.now()):item.resolvedOn=null,BacklogService.save(item).then(function(){ctrl.formOpen=!1})},ctrl.filterItems=function(x){x==ctrl.filter.state?ctrl.filter={name:ctrl.filter.name}:ctrl.filter.state=x},ctrl.dragOptions={additionalPlaceholderClass:"sortable-placeholder"},ctrl.updateOrder=function(models,oldIndex,newIndex){for(var from=Math.min(oldIndex,newIndex),to=Math.max(oldIndex,newIndex),movedUp=oldIndex>newIndex,i=from;i<=to;i++){var m=models[i];m.order=m.order+(movedUp?1:-1),BacklogService.save(m)}var draggedItem=models[oldIndex];draggedItem.order=newIndex,BacklogService.save(draggedItem)},ctrl.sortConfig={animation:150,handle:".sortable-handle",onAdd:function(e){var model=e.model,sprint=e.models[0].sprint;if(model&&model.sprint!=sprint){var index=ctrl.biItems.$indexFor(model.$id);ctrl.biItems[index].sprint=sprint,ctrl.biItems.$save(index),ctrl.reOrder(e.models)}},onRemove:function(e){ctrl.reOrder(e.models)},onUpdate:function(e){ctrl.updateOrder(e.models,e.oldIndex,e.newIndex)}}},templateUrl:templatePath+"/backlog.html"}),app.component("backlogForm",{bindings:{item:"=",items:"<",itemKey:"<",sprints:"<",attachments:"=",onAdd:"&",onDelete:"&",onSave:"&",onSelect:"&"},controller:function(BacklogService,FileService,$firebaseAuth,$firebaseArray,$firebaseObject,$location){var ctrl=this;ctrl.attachmentsToAdd;var fileSelect=document.createElement("input");fileSelect.type="file",fileSelect.multiple="multiple",fileSelect.onchange=function(evt){ctrl.uploadFiles(fileSelect.files)},ctrl.$onInit=function(){if(ctrl.itemKey){if(ctrl.item=ctrl.items.$getRecord(ctrl.itemKey),!ctrl.item)return void $location.path("/backlog");FileService.getAttachments(ctrl.item).then(function(data){ctrl.attachments=data})}},ctrl.close=function(){ctrl.item=null,$location.path("/backlog")};var mimeMap={};mimeMap["image/jpeg"]="fa-picture-o",mimeMap["image/png"]="fa-picture-o",mimeMap["image/gif"]="fa-picture-o",mimeMap["image/tif"]="fa-picture-o",mimeMap["application/pdf"]="fa-file-pdf-o",mimeMap["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]="fa-file-excel-o",mimeMap["application/vnd.openxmlformats-officedocument.presentationml.presentation"]="fa-file-powerpoint-o",mimeMap["application/vnd.openxmlformats-officedocument.wordprocessingml.document"]="fa-file-word-o",mimeMap["application/x-zip-compressed"]="fa-file-archive-o",mimeMap["video/webm"]="fa-file-video-o",ctrl.getFileIcon=function(a){return mimeMap[a.mimetype]?mimeMap[a.mimetype]:"fa-file-o"},ctrl.getFileExtention=function(a){var parts=a.name.split(".");return parts[parts.length-1]},ctrl.selectFiles=function(){ctrl.item&&fileSelect.click()},ctrl.uploadFiles=function(files){for(var f in files){var file=files[f];file instanceof File&&ctrl.uploadFile(file)}},ctrl.uploadFile=function(file){var path=ctrl.item.$id+"/"+file.name,key=-1,attachment={backlogItem:ctrl.item.$id,name:file.name,path:path,mimetype:file.type,state:1,progress:0};ctrl.attachments.$add(attachment).then(function(ref){key=ref.key;var storageRef=firebase.storage().ref(path),uploadTask=storageRef.put(file);uploadTask.on("state_changed",function progress(snapshot){var progress=snapshot.bytesTransferred/snapshot.totalBytes*100,r=ctrl.attachments.$getRecord(key);r.progress=progress,ctrl.attachments.$save(r)},function(error){},function(){var downloadURL=uploadTask.snapshot.downloadURL,r=ctrl.attachments.$getRecord(key);r.url=downloadURL,r.state=0,ctrl.attachments.$save(r)})})},ctrl.removeAttachment=function(a,e){return e.stopPropagation(),e.preventDefault(),ctrl.attachments.$remove(a),!1}},templateUrl:templatePath+"/backlogForm.html"}),app.component("bigscreen",{transclude:!0,controller:function($location,$firebaseAuth,SprintService){var ctrl=this,auth=$firebaseAuth();ctrl.auth=auth,auth.$getAuth()||$location.path("/signin"),ctrl.navOpen=!1,ctrl.signOut=function(){ctrl.auth.$signOut(),$location.path("/signin")}},templateUrl:templatePath+"/bigscreen.html"}),app.component("footer",{bindings:{sprint:"<"},controller:function(){var ctrl=this;ctrl.statOpen=!1},templateUrl:templatePath+"/footer.html"}),app.component("backlogItem",{bindings:{item:"<",onClick:"&"},controller:function(BacklogService,$firebaseAuth){},templateUrl:templatePath+"/backlogItem.html"}),app.component("chart",{bindings:{options:"<",data:"<",loaded:"<",type:"<"},controller:function($element,$scope,$timeout,$location,$rootScope,SprintService){function init(){ctrl.chart&&ctrl.chart.destroy(),ctrl.chart=new Chart($canvas,{type:ctrl.type,data:ctrl.data,options:ctrl.options}),window.chart=ctrl.chart,"/"===$location.path()&&($canvas.onclick=function(e){var activePoints=ctrl.chart.getElementsAtEvent(e);activePoints&&activePoints.length>1&&!function(){var clickedIndex=activePoints[1]._index,clickedSprint=SprintService.getCachedSprints()[clickedIndex].order;$timeout(function(){return $location.path("/sprint/"+clickedSprint)})}()})}var ctrl=this,$canvas=$element[0].querySelector("canvas");ctrl.chart,$scope.$watch(function(){return ctrl.loaded},function(loaded){loaded&&init()}),$rootScope.$on("sprint:update",function(){$timeout(function(){return ctrl.chart.update()})})},template:"<canvas></canvas>"}),app.component("overviewFooter",{bindings:{sprint:"<"},controller:function(){var ctrl=this;ctrl.statOpen=!1},templateUrl:templatePath+"/footer.html"}),app.component("retro",{bindings:{title:"<",backTitle:"<"},controller:function(RetroService,SprintService,$firebaseAuth,$firebaseArray,FileService,$scope,NotificationService){var ctrl=this;SprintService.getSprints(function(sprints){ctrl.sprints=sprints}),RetroService.getRetro().then(function(data){ctrl.RetroAgreements=data})},templateUrl:templatePath+"/retro.html"}),app.component("retroItem",{bindings:{item:"<"},controller:function(RetroService,$firebaseAuth){},templateUrl:templatePath+"/retroItem.html"}),app.component("sideNav",{bindings:{user:"<",open:"<",onSignOut:"&"},controller:function(NotificationService,$timeout,$scope){var ctrl=this;ctrl.open=!1,ctrl.hasSubscription=!1,ctrl.checkSubscription=function(){reg.pushManager.getSubscription().then(function(sub){sub?ctrl.hasSubscription=!0:ctrl.hasSubscription=!1,$timeout(function(){$scope.$apply()})})},ctrl.subscribe=function(){NotificationService.subscribe().then(function(d){ctrl.checkSubscription()})},ctrl.unsubscribe=function(){NotificationService.unsubscribe().then(function(d){ctrl.checkSubscription()})}},templateUrl:templatePath+"/sideNav.html"}),app.component("signin",{controller:function($firebaseAuth,$location){var ctrl=this;ctrl.signIn=function(name,email){$firebaseAuth().$signInWithEmailAndPassword(name,email).then(function(data){$location.path("/")})}},templateUrl:templatePath+"/signin.html"}),app.component("sprintBacklog",{bindings:{items:"<"},controller:function(BacklogService,$firebaseAuth){},templateUrl:templatePath+"/sprintBacklog.html"}),app.component("sprintRetro",{bindings:{items:"<"},controller:function(RetroService,$firebaseAuth){},templateUrl:templatePath+"/sprintRetro.html"}),app.component("sprints",{bindings:{title:"<",backTitle:"<",backlog:"<",chart:"="},controller:function($firebaseAuth,SprintService,BacklogService,$scope,$timeout,$rootScope,$location,SettingService,RetroService){var ctrl=this;$firebaseAuth();ctrl.settings=SettingService,ctrl.state={New:"0",Approved:"1",Done:"3",Removed:"4"},ctrl.stateLookup=["New","Approved","","Done","Removed"],ctrl.loaded=!1,ctrl.filter={},ctrl.openItem=function(item){$location.path("/backlog/"+item.$id)},ctrl.sumEffort=function(items){var sum=0;for(var i in items)sum+=items[i].effort;return sum},ctrl.chart.sprint&&ctrl.backlog&&(BacklogService.getBacklog(ctrl.chart.sprint).then(function(data){ctrl.BiItems=data,$timeout(function(){return ctrl.loaded=!0}),ctrl.BiItems.$loaded(function(){ctrl.chart.sprint.start&&(ctrl.setBurndown(ctrl.chart.sprint.start,ctrl.chart.sprint.duration,ctrl.BiItems),ctrl.BiItems.$watch(function(e){ctrl.setBurndown(ctrl.chart.sprint.start,ctrl.chart.sprint.duration,ctrl.BiItems),$rootScope.$broadcast("sprint:update")}))})}),RetroService.getRetro(ctrl.chart.sprint).then(function(data){ctrl.RetroAgreements=data})),ctrl.filterItems=function(x){x==ctrl.filter.state?ctrl.filter={name:ctrl.filter.name}:ctrl.filter.state=x},ctrl.$onInit=function(){ctrl.chart.sprint&&ctrl.backlog||(ctrl.loaded=!0),ctrl.viewMode=ctrl.settings.get("ViewMode",0)},ctrl.setViewMode=function(mode){ctrl.viewMode=mode,ctrl.settings.set("ViewMode",mode)},ctrl.setBurndown=function(start,duration,backlog){start=new Date(1e3*start);for(var dates=[],burndown=[],daysToAdd=0,velocityRemaining=ctrl.chart.sprint.velocity,graphableBurndown=[],totalBurndown=0,i=0;i<=duration;i++){var newDate=start.addDays(daysToAdd-1);newDate>new Date||([0,6].indexOf(newDate.getDay())>=0?(daysToAdd++,newDate=start.addDays(daysToAdd),i--):(dates.push(newDate),daysToAdd++))}for(var i in dates){var d=dates[i],bdown=0;for(var i2 in backlog){var bli=backlog[i2];if("3"==bli.state){var bliDate=new Date(parseInt(bli.resolvedOn));bliDate.getDate()==d.getDate()&&bliDate.getMonth()==d.getMonth()&&bliDate.getFullYear()==d.getFullYear()&&(bdown+=bli.effort)}}burndown.push({date:d,burndown:bdown})}for(var x in burndown)totalBurndown+=burndown[x].burndown,velocityRemaining-=burndown[x].burndown,graphableBurndown.push(velocityRemaining);ctrl.chart.burndown=totalBurndown,ctrl.chart.remaining=velocityRemaining,ctrl.chart.data.datasets[0].data=graphableBurndown}},templateUrl:templatePath+"/sprints.html"}),Date.prototype.addDays=function(days){var dat=new Date(this.valueOf());return dat.setDate(dat.getDate()+days),dat},app.component("textNotes",{bindings:{title:"<",type:"<",sprint:"<"},controller:function($firebaseAuth,NoteService,$scope,$timeout,$rootScope){var ctrl=this,auth=$firebaseAuth();ctrl.newNote={note:"",author:auth.$getAuth().uid,timestamp:0,sprint:ctrl.sprint.$id},ctrl.init=function(){NoteService.getNotes(ctrl.type,ctrl.sprint).then(function(d){ctrl.notes=d,console.log(d)})},ctrl.saveNote=function(){ctrl.newNote.timestamp=Date.now(),NoteService.add(ctrl.type,ctrl.newNote,ctrl.notes).then(function(){ctrl.newNote={note:"",author:auth.$getAuth().uid,timestamp:0,sprint:ctrl.sprint.$id}})}},templateUrl:templatePath+"/textNotes.html"}),app.factory("BacklogService",function($rootScope,$firebaseArray,$firebaseObject,UtilityService,$q,$filter,$location,$timeout){function getBacklog(sprint){return $q(function(resolve,reject){backlog=$firebaseArray(sprint?ref.child("backlog").orderByChild("sprint").equalTo(sprint.$id):ref.child("backlog").orderByChild("order")),resolve(backlog.$loaded())})}function add(backlogItem){return backlog.$add(backlogItem)}function remove(backlogItem){return backlog.$remove(backlogItem)}function save(backlogItem){return backlog.$save(backlogItem)}var ref=firebase.database().ref(),backlog=void 0;return{getBacklog:getBacklog,save:save,add:add,remove:remove}}),app.factory("FileService",function($rootScope,UtilityService,$q,$timeout,$firebaseArray){function getAttachments(backlogItem){return $q(function(resolve,reject){backlogItem?(attachments=$firebaseArray(ref.child("attachments").orderByChild("backlogItem").equalTo(backlogItem.$id)),resolve(attachments)):reject("Backlog item not provided")})}var ref=firebase.database().ref(),attachments=void 0;return{getAttachments:getAttachments}}),app.factory("NoteService",function($rootScope,$firebaseArray,$firebaseObject,UtilityService,$q){function getNotes(type,sprint){return console.log(type),$q(function(resolve,reject){var n=$firebaseArray(ref.child("notes/"+type).orderByChild("sprint").equalTo(sprint.$id));resolve(n)})}function add(type,note,notes){return notes.$add(note)}function remove(type,note,notes){return notes.$remove(note)}function save(type,note,notes){return notes.$save(note)}var ref=firebase.database().ref();return{getNotes:getNotes,save:save,add:add,remove:remove}}),app.factory("NotificationService",function($rootScope,$firebaseArray,$firebaseObject,UtilityService,$q,$firebaseAuth,$http){function subscribe(){return $q(function(resolve,reject){console.log(reg),reg.pushManager.getSubscription().then(function(sub){if(sub)return void resolve(!1)}),reg.pushManager.subscribe({userVisibleOnly:!0}).then(function(pushSubscription){var sub=pushSubscription;console.log("Subscribed! Endpoint:",sub.endpoint);var endpoint=sub.endpoint.split("/");endpoint=endpoint[endpoint.length-1];var subscriptions=$firebaseArray(ref.child("subscriptions").orderByChild("endpoint").equalTo(endpoint));subscriptions.$loaded().then(function(data){!subscriptions.length>0&&subscriptions.$add({uid:userId,endpoint:endpoint,keys:JSON.parse(JSON.stringify(pushSubscription)).keys}),resolve(!0)})})})}function unsubscribe(){return $q(function(resolve,reject){reg.pushManager.getSubscription().then(function(sub){if(!sub)return void resolve(!1);var endpoint=sub.endpoint.split("/");endpoint=endpoint[endpoint.length-1],sub.unsubscribe().then(function(d){var subscriptions=$firebaseArray(ref.child("subscriptions").orderByChild("endpoint").equalTo(endpoint));subscriptions.$loaded().then(function(data){subscriptions.length>0&&subscriptions.$remove(0),resolve(!0)})})})})}function notify(title,message){return $q(function(resolve,reject){$http({url:"https://notifications.boerdamdns.nl/api/notify/post?title="+title+"&message="+message,method:"POST"}).then(function(a){resolve(a)})})}var ref=firebase.database().ref(),auth=$firebaseAuth(),userId=auth.$getAuth().uid,reg=window.reg;return{subscribe:subscribe,unsubscribe:unsubscribe,notify:notify}}),app.factory("RetroService",function($firebaseArray,$firebaseObject,UtilityService,$q,$filter,$location,$timeout){function getRetro(sprint){return $q(function(resolve,reject){sprint?(retro=$firebaseArray(ref.child("retro").orderByChild("sprint").equalTo(sprint.$id)),resolve(retro)):(retro=$firebaseArray(ref.child("retro").orderByChild("sprint")),resolve(retro))})}function add(retroAgreement){return retro.$add(retroAgreement)}function remove(retroAgreement){return retro.$remove(retroAgreement)}function save(retroAgreement){return retro.$save(retroAgreement)}var ref=firebase.database().ref(),retro=void 0;return{getRetro:getRetro,save:save,add:add,remove:remove}}),app.factory("SettingService",function(){function set(key,value){localStorage.setItem(key,value)}function get(key,defaultValue){return localStorage.getItem(key)||defaultValue}return{set:set,get:get}}),app.factory("SprintService",function($rootScope,$firebaseArray,$firebaseObject,UtilityService,$q,$filter,$location,$timeout){function getSprints(cb,all){if(all){var sprints=$firebaseArray(ref.child("sprints").orderByChild("order"));sprints.$loaded(cb,function(){return $location.path("/signin")})}else{var sprints=$firebaseArray(ref.child("sprints").orderByChild("order").limitToLast(9));sprints.$loaded(cb,function(){return $location.path("/signin")})}}function getCachedSprints(){return cachedSprints}function getOverviewChart(){var deferred=$q.defer();return getSprints(function(sprints){sprints.$loaded(function(){cachedSprints=sprints,updateOverviewChart(deferred,sprints),sprints.$watch(function(){cachedSprints=sprints,$rootScope.$broadcast("sprint:update"),updateOverviewChart(deferred,sprints)})})}),deferred.promise}function updateOverviewChart(deferred,sprints){var labels=void 0,estimated=void 0,burned=void 0,average=[];labels=sprints.map(function(d){return"Sprint "+_.pad(d.order)}),estimated=sprints.map(function(d){return d.velocity}),burned=sprints.map(function(d){var i=0;for(var x in d.burndown)i+=d.burndown[x];return i});for(var sum=0,i=0;i<burned.length-1;i++)sum+=parseInt(burned[i],10);for(var avg=sum/(burned.length-1),i=0;i<sprints.length;i++)average.push(avg);var data=overviewData;data.labels=labels,data.datasets[2].data=burned,data.datasets[1].data=estimated,data.datasets[0].data=average;var overviewChartOptions=chartOptions;overviewChartOptions.scales.yAxes[0].ticks.suggestedMax=100;var currentSprint=sprints[sprints.length-1],chartObj={type:"bar",options:overviewChartOptions,data:data,velocity:currentSprint.velocity,burndown:_.sum(currentSprint.burndown),remaining:currentSprint.velocity-_.sum(currentSprint.burndown),needed:$filter("number")(currentSprint.velocity/currentSprint.duration,1)};deferred.resolve(chartObj)}function buildBurnDownChart(sprint){var labels=["di","wo","do","vr","ma","di ","wo ","do ","vr ","ma "].slice(0,sprint.duration+1),idealBurndown=labels.map(function(d,i){return i===labels.length-1?sprint.velocity.toFixed(2):(sprint.velocity/sprint.duration*i).toFixed(2)}).reverse(),velocityRemaining=sprint.velocity,graphableBurndown=[];for(var x in sprint.burndown)velocityRemaining-=sprint.burndown[x],graphableBurndown.push(velocityRemaining);var data=burndownData;data.labels=labels,data.datasets[0].data=graphableBurndown,data.datasets[1].data=idealBurndown;var burndownChartOptions=chartOptions;burndownChartOptions.scales.yAxes[0].ticks.suggestedMax=10*(sprint.duration+1);var chartObj={type:"line",options:burndownChartOptions,data:data,velocity:sprint.velocity,name:sprint.name,burndown:_.sum(sprint.burndown),remaining:sprint.velocity-_.sum(sprint.burndown),needed:$filter("number")(sprint.velocity/sprint.duration,1),sprint:sprint};return chartObj}function getCurrentChart(){var deferred=$q.defer();return getSprints(function(sprints){var current=sprints.$keyAt(sprints.length-1),currentSprint=(current.split("s")[1],$firebaseObject(ref.child("sprints/"+current)));currentSprint.$watch(function(e){$rootScope.$broadcast("sprint:update"),deferred.resolve(buildBurnDownChart(currentSprint))})}),deferred.promise}function getSprintChart(sprintNumber){var deferred=$q.defer();return getSprints(function(sprints){var sprint=$firebaseObject(ref.child("sprints/s"+sprintNumber));sprint.$watch(function(e){$rootScope.$broadcast("sprint:update"),deferred.resolve(buildBurnDownChart(sprint))})}),deferred.promise}var _=UtilityService,ref=firebase.database().ref(),lineColor="#EB51D8",barColor="#5FFAFC",cachedSprints=void 0,chartOptions={responsive:!0,maintainAspectRatio:!1,tooltips:{mode:"single",cornerRadius:3},elements:{line:{fill:!1}},legend:{display:!1},scales:{xAxes:[{display:!0,gridLines:{display:!1,color:"rgba(255,255,255,.1)"},ticks:{fontColor:"#fff"}}],yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1",ticks:{stepSize:10,suggestedMin:0,fontColor:"#fff",suggestedMax:null},gridLines:{display:!0,color:"rgba(255,255,255,.1)",drawTicks:!1},labels:{show:!0}}]}},overviewData={labels:[],datasets:[{type:"line",label:"Average",data:[],fill:!1,backgroundColor:"#58F484",borderColor:"#58F484",hoverBackgroundColor:"#58F484",hoverBorderColor:"#58F484",yAxisID:"y-axis-1"},{type:"line",label:"Estimated",data:[],fill:!1,backgroundColor:lineColor,borderColor:lineColor,hoverBackgroundColor:"#5CE5E7",hoverBorderColor:"#5CE5E7",yAxisID:"y-axis-1"},{label:"Achieved",type:"bar",data:[],fill:!1,borderColor:barColor,backgroundColor:barColor,pointBorderColor:barColor,pointBackgroundColor:barColor,pointHoverBackgroundColor:barColor,pointHoverBorderColor:barColor,yAxisID:"y-axis-1"}]},burndownData={labels:["di","wo","do","vr","ma","di ","wo ","do ","vr ","ma "],datasets:[{label:"Gehaald",type:"line",data:[],fill:!1,yAxisID:"y-axis-1",borderColor:lineColor,backgroundColor:lineColor,pointBorderColor:lineColor,pointBackgroundColor:lineColor,pointHoverBackgroundColor:lineColor,pointHoverBorderColor:lineColor,hitRadius:15,lineTension:0},{type:"line",label:"Mean Burndown",data:[],fill:!1,yAxisID:"y-axis-1",borderColor:barColor,backgroundColor:barColor,pointBorderColor:barColor,pointBackgroundColor:barColor,pointHoverBackgroundColor:barColor,pointHoverBorderColor:barColor,hitRadius:15,lineTension:0}]};return{getSprints:getSprints,getOverviewChart:getOverviewChart,getCurrentChart:getCurrentChart,getSprintChart:getSprintChart,getCachedSprints:getCachedSprints}}),app.factory("UtilityService",function(){function pad(n){return n<10?"0"+n:n}function sum(items){var i=0;for(var x in items)i+=items[x];return i}return{pad:pad,sum:sum}});